    <!DOCTYPE html>
    <html lang="zh-TW">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Finviz SMA200 ÁØ©ÈÅ∏Âô®</title>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
            rel="stylesheet">
        <style>
            :root {
                --bg-color: #0f172a;
                /* slate-900 */
                --text-primary: #f8fafc;
                /* slate-50 */
                --text-secondary: #94a3b8;
                /* slate-400 */
                --card-bg: rgba(30, 41, 59, 0.7);
                /* slate-800 with transparency */
                --border-color: rgba(71, 85, 105, 0.5);
                /* slate-600 with transparency */
                --hover-bg: rgba(51, 65, 85, 0.5);
                /* slate-700 with transparency */
                --accent-color: #38bdf8;
                /* sky-400 */
                --success-color: #4ade80;
                /* green-400 */
                --danger-color: #ef4444;
                /* red-500 */
            }

            .light-mode {
                --bg-color: #f8fafc;
                /* slate-50 */
                --text-primary: #0f172a;
                /* slate-900 */
                --text-secondary: #475569;
                /* slate-600 */
                --card-bg: rgba(255, 255, 255, 0.7);
                --border-color: rgba(203, 213, 225, 0.8);
                /* slate-300 with transparency */
                --hover-bg: rgba(241, 245, 249, 0.8);
                /* slate-100 with transparency */
                --accent-color: #0ea5e9;
                /* sky-500 */
                --success-color: #22c55e;
                /* green-500 */
                --danger-color: #dc2626;
                /* red-600 */
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Inter', sans-serif;
                background-color: var(--bg-color);
                color: var(--text-primary);
                line-height: 1.6;
                min-height: 100vh;
                background-image:
                    radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.1) 0px, transparent 50%),
                    radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.1) 0px, transparent 50%);
                transition: background-color 0.3s ease;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 2rem;
            }

            header {
                margin-bottom: 3rem;
                text-align: center;
            }

            h1 {
                font-size: 2.5rem;
                font-weight: 700;
                background: linear-gradient(to right, #38bdf8, #818cf8);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                margin-bottom: 1rem;
            }

            .subtitle {
                color: var(--text-secondary);
                font-size: 1.1rem;
            }

            .glass-panel {
                background: var(--card-bg);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                border: 1px solid var(--border-color);
                border-radius: 1rem;
                overflow: hidden;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }

            .controls {
                padding: 1.5rem;
                display: flex;
                flex-wrap: wrap;
                gap: 1rem;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid var(--border-color);
            }

            .search-box {
                position: relative;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .search-input {
                background: rgba(15, 23, 42, 0.5);
                border: 1px solid var(--border-color);
                color: var(--text-primary);
                padding: 0.75rem 1rem 0.75rem 2.5rem;
                border-radius: 0.5rem;
                font-size: 0.95rem;
                width: 300px;
                transition: all 0.2s;
            }

            .light-mode .search-input {
                background: rgba(255, 255, 255, 0.5);
            }

            .search-input:focus {
                outline: none;
                border-color: var(--accent-color);
                box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2);
            }

            .search-icon {
                position: absolute;
                left: 0.75rem;
                top: 50%;
                transform: translateY(-50%);
                color: var(--text-secondary);
                width: 1.25rem;
                height: 1.25rem;
            }

            .table-container {
                overflow-x: auto;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                text-align: left;
            }

            th {
                padding: 1rem 1.5rem;
                font-weight: 600;
                color: var(--text-secondary);
                border-bottom: 1px solid var(--border-color);
                cursor: pointer;
                transition: color 0.2s;
                user-select: none;
                white-space: nowrap;
            }

            th:hover {
                color: var(--text-primary);
            }

            th span {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
            }

            td {
                padding: 1rem 1.5rem;
                border-bottom: 1px solid var(--border-color);
                transition: background-color 0.2s;
            }

            tr:last-child td {
                border-bottom: none;
            }

            tr:hover td {
                background-color: var(--hover-bg);
            }

            .ticker {
                font-weight: 700;
                color: var(--text-primary);
            }

            .trend-badge {
                display: inline-flex;
                align-items: center;
                padding: 0.25rem 0.75rem;
                border-radius: 9999px;
                font-size: 0.875rem;
                font-weight: 500;
            }

            .trend-bullish {
                background-color: rgba(74, 222, 128, 0.1);
                color: var(--success-color);
                border: 1px solid rgba(74, 222, 128, 0.2);
            }

            .trend-bearish {
                background-color: rgba(239, 68, 68, 0.1);
                color: var(--danger-color);
                border: 1px solid rgba(239, 68, 68, 0.2);
            }

            .loading {
                text-align: center;
                padding: 2rem;
                color: var(--text-secondary);
            }

            .button {
                background-color: var(--accent-color);
                color: var(--bg-color);
                padding: 0.75rem 1.25rem;
                border-radius: 0.5rem;
                border: none;
                cursor: pointer;
                font-size: 0.95rem;
                font-weight: 600;
                transition: background-color 0.2s, transform 0.1s;
            }

            .button:hover {
                background-color: #0ea5e9;
                /* sky-500 */
                transform: translateY(-1px);
            }

            .button:active {
                transform: translateY(0);
            }

            .button.secondary {
                background-color: var(--border-color);
                color: var(--text-primary);
            }

            .button.secondary:hover {
                background-color: var(--hover-bg);
            }

            .input-group {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                color: var(--text-secondary);
                font-size: 0.95rem;
            }

            .input-group input[type="number"] {
                background: rgba(15, 23, 42, 0.5);
                border: 1px solid var(--border-color);
                color: var(--text-primary);
                padding: 0.5rem 0.75rem;
                border-radius: 0.5rem;
                width: 70px;
                text-align: center;
                -moz-appearance: textfield;
                /* Firefox */
            }

            .light-mode .input-group input[type="number"] {
                background: rgba(255, 255, 255, 0.5);
            }

            .input-group input[type="number"]::-webkit-outer-spin-button,
            .input-group input[type="number"]::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            .input-group input[type="number"]:focus {
                outline: none;
                border-color: var(--accent-color);
                box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2);
            }

            .checkbox-wrapper {
                text-align: center;
            }

            .checkbox-wrapper input[type="checkbox"] {
                width: 1.25rem;
                height: 1.25rem;
                accent-color: var(--accent-color);
                cursor: pointer;
            }

            .results-view {
                display: none;
                /* Hidden by default */
                padding-top: 2rem;
            }

            .results-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 2rem;
            }

            .results-header h2 {
                font-size: 2rem;
                color: var(--text-primary);
            }

            .results-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 2rem;
            }

            .result-card {
                padding: 1.5rem;
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }

            .result-header {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                border-bottom: 1px solid var(--border-color);
                padding-bottom: 1rem;
            }

            .result-title {
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--text-primary);
            }

            .result-stats {
                display: flex;
                flex-wrap: wrap;
                gap: 1rem;
                font-size: 0.9rem;
                color: var(--text-secondary);
            }

            .result-stat-item strong {
                color: var(--text-primary);
            }

            .result-body {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }

            .chart-container {
                width: 100%;
                height: 200px;
                /* Adjust as needed */
                background-color: rgba(0, 0, 0, 0.1);
                border-radius: 0.5rem;
                overflow: hidden;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .chart-container img {
                width: 100%;
                height: 100%;
                object-fit: contain;
            }

            .calc-info {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
                font-size: 1.1rem;
            }

            .calc-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem 0;
                border-bottom: 1px dashed var(--border-color);
            }

            .calc-row:last-child {
                border-bottom: none;
            }

            .calc-label {
                color: var(--text-secondary);
            }

            .calc-value {
                font-weight: 600;
            }

            @media (max-width: 768px) {
                .controls {
                    flex-direction: column;
                    align-items: flex-start;
                }

                .search-input {
                    width: 100%;
                }

                .results-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 1rem;
                }
            }
        </style>
    </head>

<body>
    <div class="container">
        <header>
            <h1>Finviz SMA200 ÁØ©ÈÅ∏Âô®</h1>
            <p class="subtitle">Âø´ÈÄüÁØ©ÈÅ∏‰∏¶Ë®àÁÆóËÇ°Á•®ÁöÑÈóúÈçµÂÉπÊ†ºÈªû</p>
        </header>

        <main id="mainView">
            <div class="glass-panel">
                <div class="controls">
                    <div class="search-box">
                        <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <input type="text" id="searchInput" class="search-input" placeholder="ÊêúÂ∞ãËÇ°Á•®‰ª£Á¢º...">
                    </div>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <div class="input-group">
                            KO: <input type="number" id="inputKO" value="100" min="1" max="200">%
                        </div>
                        <div class="input-group">
                            K: <input type="number" id="inputK" value="80" min="1" max="200">%
                        </div>
                        <div class="input-group">
                            KI: <input type="number" id="inputKI" value="65" min="1" max="200">%
                        </div>
                        <button class="button" onclick="calculateSelected()">Ë®àÁÆóÂ∑≤ÈÅ∏ (<span
                                id="selectedCount">0</span>)</button>
                        <button class="button secondary" id="themeToggle" onclick="toggleTheme()">üåô Â§úÈñìÊ®°Âºè</button>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 50px;"></th> <!-- Checkbox column -->
                                <th data-key="Ticker" onclick="handleSort('Ticker')">
                                    <span>‰ª£Á¢º <span class="sort-icon">‚Üï</span></span>
                                </th>
                                <th data-key="Price" onclick="handleSort('Price')">
                                    <span>ÂÉπÊ†º <span class="sort-icon">‚Üï</span></span>
                                </th>
                                <th data-key="SMA200" onclick="handleSort('SMA200')">
                                    <span>SMA200 <span class="sort-icon">‚Üï</span></span>
                                </th>
                                <th data-key="Volatility W" onclick="handleSort('Volatility W')">
                                    <span>Âë®Ê≥¢ÂãïÁéá <span class="sort-icon">‚Üï</span></span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="5" class="loading">ËºâÂÖ•‰∏≠...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="controls"
                    style="justify-content: center; border-top: 1px solid var(--border-color); border-bottom: none;">
                    <span id="statusCount" style="color: var(--text-secondary); font-size: 0.9rem;"></span>
                </div>
            </div>
        </main>

        <div id="resultsView" class="results-view">
            <div class="results-header">
                <h2>Ë®àÁÆóÁµêÊûú</h2>
                <button class="button secondary" onclick="showMainView()">ËøîÂõûÂàóË°®</button>
            </div>
            <div class="results-grid" id="resultsContainer">
                <!-- Calculation results will be rendered here -->
            </div>
        </div>
    </div>

    <script>
        const TARGET_URL = 'https://pub-1434d512b03145d98095bbff4adf4b4a.r2.dev/finviz_data.json';
        const PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest=',
            'https://thingproxy.freeboard.io/fetch/'
        ];

        let rawData = [];
        let currentSort = { key: 'Ticker', direction: 'asc' };
        let selectedStocks = new Set();
        let isNightMode = false;

        // Theme Toggle
        function toggleTheme() {
            const body = document.body;
            const btn = document.getElementById('themeToggle');
            body.classList.toggle('light-mode');

            if (body.classList.contains('light-mode')) {
                btn.textContent = '‚òÄÔ∏è ‰∏ÄËà¨Ê®°Âºè';
                isNightMode = false;
            } else {
                btn.textContent = 'üåô Â§úÈñìÊ®°Âºè';
                isNightMode = true;
            }
        }

        // Selection Logic
        function toggleSelection(ticker) {
            if (selectedStocks.has(ticker)) {
                selectedStocks.delete(ticker);
            } else {
                if (selectedStocks.size >= 5) {
                    alert('ÊúÄÂ§öÂè™ËÉΩÈÅ∏Êìá 5 Ê™îÂÄãËÇ°');
                    // Uncheck the box that was just clicked
                    const checkbox = document.querySelector(`input[data-ticker="${ticker}"]`);
                    if (checkbox) checkbox.checked = false;
                    return;
                }
                selectedStocks.add(ticker);
            }
            updateSelectedCount();
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedStocks.size;
        }

        // Calculation Logic
        function calculateSelected() {
            if (selectedStocks.size === 0) {
                alert('Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÊ™îÂÄãËÇ°');
                return;
            }

            const koPct = parseFloat(document.getElementById('inputKO').value) || 100;
            const kPct = parseFloat(document.getElementById('inputK').value) || 80;
            const kiPct = parseFloat(document.getElementById('inputKI').value) || 65;

            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '';

            const selectedData = rawData.filter(d => selectedStocks.has(d.Ticker));

            selectedData.forEach(item => {
                const price = item._price;
                const koPrice = (price * koPct / 100).toFixed(2);
                const kPrice = (price * kPct / 100).toFixed(2);
                const kiPrice = (price * kiPct / 100).toFixed(2);

                // Construct Chart URL
                const chartUrl = `https://charts2-node.finviz.com/chart.ashx?cs=&t=${item.Ticker}&tf=d&s=linear&pm=240&am=1200&ct=candle_stick&o[0][ot]=sma&o[0][op]=50&o[0][oc]=FF8F33C6&o[1][ot]=sma&o[1][op]=200&o[1][oc]=DCB3326D&o[2][ot]=patterns&o[2][op]=&o[2][oc]=000&sf=2`;

                const isBullish = item._sma200 > 0;
                const trendClass = isBullish ? 'trend-bullish' : 'trend-bearish';
                const trendText = isBullish ? 'Â§öÈ†≠' : 'Á©∫È†≠';

                const card = document.createElement('div');
                card.className = 'result-card glass-panel';
                card.innerHTML = `
                    <div class="result-header">
                        <div class="result-title">${item.Ticker}</div>
                        <div class="result-stats">
                            <div class="result-stat-item">ÊúÄÊñ∞ËÇ°ÂÉπ: <strong>$${item.Price}</strong></div>
                            <div class="result-stat-item">Ë∂®Âã¢: <span class="trend-badge ${trendClass}">${trendText} (${item.SMA200})</span></div>
                            <div class="result-stat-item">Âë®Ê≥¢ÂãïÁéá: <strong>${item["Volatility W"]}</strong></div>
                        </div>
                    </div>
                    <div class="result-body">
                        <div class="chart-container">
                            <img src="${chartUrl}" alt="${item.Ticker} Chart" loading="lazy">
                        </div>
                        <div class="calc-info">
                            <div class="calc-row">
                                <span class="calc-label">KO (${koPct}%)</span>
                                <span class="calc-value" style="color: var(--success-color)">$${koPrice}</span>
                            </div>
                            <div class="calc-row">
                                <span class="calc-label">K (${kPct}%)</span>
                                <span class="calc-value" style="color: var(--accent-color)">$${kPrice}</span>
                            </div>
                            <div class="calc-row">
                                <span class="calc-label">KI (${kiPct}%)</span>
                                <span class="calc-value" style="color: var(--danger-color)">$${kiPrice}</span>
                            </div>
                        </div>
                    </div>
                `;
                resultsContainer.appendChild(card);
            });

            document.getElementById('mainView').style.display = 'none';
            document.getElementById('resultsView').style.display = 'block';
            window.scrollTo(0, 0);
        }

        function showMainView() {
            document.getElementById('resultsView').style.display = 'none';
            document.getElementById('mainView').style.display = 'block';
        }

        async function fetchData() {
            const statusEl = document.getElementById('statusCount');
            const tbody = document.getElementById('tableBody');

            // Helper to try fetching with timeout
            const tryFetch = async (url) => {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5s timeout

                try {
                    const response = await fetch(url, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    clearTimeout(timeoutId);
                    throw error;
                }
            };

            try {
                statusEl.innerHTML = 'Ê≠£Âú®ÂòóË©¶Áõ¥Êé•ÈÄ£Á∑ö...';
                // 1. Try direct connection first
                try {
                    const data = await tryFetch(TARGET_URL);
                    processData(data);
                    return;
                } catch (e) {
                    console.log('Direct fetch failed, trying proxies...', e);
                }

                // 2. Try proxies
                for (const proxy of PROXIES) {
                    const proxyUrl = proxy + encodeURIComponent(TARGET_URL);
                    const proxyName = new URL(proxy).hostname;
                    statusEl.innerHTML = `Ê≠£Âú®ÂòóË©¶‰ª£ÁêÜÈÄ£Á∑ö (${proxyName})...`;

                    try {
                        console.log(`Trying proxy: ${proxyName}`);
                        const data = await tryFetch(proxyUrl);
                        processData(data);
                        statusEl.innerHTML += ` <span style="color: var(--success-color)">(ÈÄ£Á∑öÊàêÂäü)</span>`;
                        return;
                    } catch (e) {
                        console.warn(`Proxy ${proxyName} failed:`, e);
                    }
                }

                // 3. Try local fallback
                statusEl.innerHTML = 'Ê≠£Âú®ÂòóË©¶ËÆÄÂèñÊú¨Âú∞ÂÇô‰ªΩË≥áÊñô...';
                try {
                    const data = await tryFetch('finviz_data.json');
                    processData(data);
                    statusEl.innerHTML = '<span style="color: var(--accent-color)">‚ö†Ô∏è ‰ΩøÁî®Êú¨Âú∞ÂÇô‰ªΩË≥áÊñô (ÈùûÂç≥ÊôÇ)</span>';
                    return;
                } catch (e) {
                    console.warn('Local fallback failed:', e);
                }

                throw new Error('ÊâÄÊúâÈÄ£Á∑öÊñπÂºèÁöÜÂ§±Êïó (All connection methods failed)');

            } catch (error) {
                console.error('Error fetching data:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="loading" style="color: var(--danger-color)">
                            <strong>ËÆÄÂèñÊï∏ÊìöÂ§±Êïó</strong><br>
                            <span style="font-size: 0.9em; opacity: 0.8">
                                ÁÑ°Ê≥ïÈÄèÈÅé‰ªª‰ΩïÊñπÂºè (Áõ¥Êé•„ÄÅ‰ª£ÁêÜ„ÄÅÊú¨Âú∞) ÂèñÂæóË≥áÊñô„ÄÇ<br>
                                ÈåØË™§Ë®äÊÅØ: ${error.message}
                            </span>
                        </td>
                    </tr>
                `;
                statusEl.innerHTML = '<span style="color: var(--danger-color)">ËÆÄÂèñÂ§±Êïó</span>';
            }
        }

        function processData(data) {
            // Transform data to ensure numbers are numbers
            rawData = data.map(item => ({
                ...item,
                _price: parseFloat(item.Price) || 0,
                _sma200: parseFloat(item.SMA200.replace('%', '')) || 0,
                _volatility: parseFloat(item["Volatility W"].replace('%', '')) || 0
            }));

            renderTable(rawData);
            updateStats(rawData);
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">Ê≤íÊúâÊâæÂà∞Á¨¶ÂêàÁöÑË≥áÊñô</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => {
                const isBullish = item._sma200 > 0;
                const trendClass = isBullish ? 'trend-bullish' : 'trend-bearish';
                const trendText = isBullish ? 'Â§öÈ†≠' : 'Á©∫È†≠';
                const trendIcon = isBullish ? '‚Üë' : '‚Üì';
                const isSelected = selectedStocks.has(item.Ticker) ? 'checked' : '';

                return `
                    <tr>
                        <td class="checkbox-wrapper">
                            <input type="checkbox" data-ticker="${item.Ticker}" onchange="toggleSelection('${item.Ticker}')" ${isSelected}>
                        </td>
                        <td class="ticker">${item.Ticker}</td>
                        <td class="price">$${item.Price}</td>
                        <td>
                            <span class="trend-badge ${trendClass}">
                                ${trendIcon} ${item.SMA200} (${trendText})
                            </span>
                        </td>
                        <td class="volatility">${item["Volatility W"]}</td>
                    </tr>
                `;
            }).join('');
        }

        function handleSort(key) {
            if (currentSort.key === key) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.key = key;
                if (key === 'Ticker') {
                    currentSort.direction = 'asc';
                } else {
                    currentSort.direction = 'desc'; // Numbers usually better desc first
                }
            }

            // Update header styles
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('active');
                const icon = th.querySelector('.sort-icon');
                if (icon) icon.textContent = '‚Üï';

                if (th.dataset.key === key) {
                    th.classList.add('active');
                    if (icon) icon.textContent = currentSort.direction === 'asc' ? '‚Üë' : '‚Üì';
                }
            });

            // Sort data
            const sortedData = [...rawData].sort((a, b) => {
                let valA, valB;

                switch (key) {
                    case 'Price':
                        valA = a._price;
                        valB = b._price;
                        break;
                    case 'SMA200':
                        valA = a._sma200;
                        valB = b._sma200;
                        break;
                    case 'Volatility W':
                        valA = a._volatility;
                        valB = b._volatility;
                        break;
                    default:
                        valA = a[key];
                        valB = b[key];
                }

                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            // Re-apply search filter if exists
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredData = sortedData.filter(item =>
                item.Ticker.toLowerCase().includes(searchTerm)
            );

            renderTable(filteredData);
        }

        function updateStats(data) {
            const total = data.length;
            const bullish = data.filter(d => d._sma200 > 0).length;
            const bearish = total - bullish;

            document.getElementById('statusCount').innerHTML = `
                Á∏ΩË®à: ${total} | 
                <span style="color: var(--success-color)">Â§öÈ†≠: ${bullish}</span> | 
                <span style="color: var(--danger-color)">Á©∫È†≠: ${bearish}</span>
            `;
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredData = rawData.filter(item =>
                item.Ticker.toLowerCase().includes(searchTerm)
            );

            // Note: We are losing the sort order here for simplicity, 
            // but in a real app we would sort the filtered results.
            // Let's just render for now.
            renderTable(filteredData);
        });

        // Initialize
        fetchData();
    </script>
</body>

</html>
